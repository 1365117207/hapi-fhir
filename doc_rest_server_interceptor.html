<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 2014-11-20 
 | Rendered using Apache Maven Fluido Skin 1.3.1
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="James Agnew" />
    <meta name="Date-Revision-yyyymmdd" content="20141120" />
    <meta http-equiv="Content-Language" content="en" />
    <title>HAPI &#x2013; Server Interceptors - HAPI FHIR</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.3.1.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.3.1.min.js"></script>

                          
        
<script src="syntaxhighlighter/shCore.js" type="text/javascript"></script>
                      
        
<script src="syntaxhighlighter/shBrushJScript.js" type="text/javascript"></script>
                      
        
<script src="syntaxhighlighter/shBrushJava.js" type="text/javascript"></script>
                      
        
<script src="syntaxhighlighter/shBrushBash.js" type="text/javascript"></script>
                      
        
<script src="syntaxhighlighter/shBrushXml.js" type="text/javascript"></script>
                      
        
<link rel="stylesheet" type="text/css" href="syntaxhighlighter/shCore.css"/>
                      
        
<link rel="stylesheet" type="text/css" href="syntaxhighlighter/shThemeDefault.css"/>
                      
        
<link rel="shortcut icon" href="https://github.com/jamesagnew/hapi-fhir/images/favicon.png"/>
                      
        
<link rel="stylesheet" type="text/css" href="hapi.css"/>
          
                  </head>
        <body class="topBarDisabled">
          
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                    <a href="http://jamesagnew.github.io/hapi-fhir/" id="bannerLeft">
                                                                                                <img src="images/hapi_fhir_banner.png"  alt="HAPI"/>
                </a>
                      </div>
        <div class="pull-right">                  <a href="http://jamesagnew.github.io/hapi-fhir/" id="bannerRight">
                                                                                                <img src="images/hapi_fhir_banner_right.png"  alt="FHIR"/>
                </a>
      </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">Last Published: 2014-11-20
                      <span class="divider">|</span>
                   </li>
                  <li id="projectVersion">Version: 0.8-SNAPSHOT
                      </li>
                      
                
                    
      
                                    
    <li class="pull-right">
        <span class="divider">|</span>
                      <a href="http://www.uhn.ca/" class="externalLink" title="University Health Network">
        University Health Network</a>
      </li>

  
    <li class="pull-right">
        <span class="divider">|</span>
                      <a href="http://hl7.org/" class="externalLink" title="hl7.org">
        hl7.org</a>
      </li>

  
    <li class="pull-right">
                      <a href="https://github.com/jamesagnew/hapi-fhir/" class="externalLink" title="GitHub Page">
        GitHub Page</a>
      </li>

                    </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">Welcome</li>
                              
      <li>
  
                          <a href="index.html" title="Welcome">
          <i class="none"></i>
        Welcome</a>
            </li>
                
      <li>
  
                          <a href="download.html" title="Download">
          <i class="none"></i>
        Download</a>
            </li>
                
      <li>
  
                          <a href="doc_upgrading.html" title="Upgrade Guide">
          <i class="none"></i>
        Upgrade Guide</a>
            </li>
                
      <li>
  
                          <a href="changes-report.html" title="Changelog">
          <i class="none"></i>
        Changelog</a>
            </li>
                              <li class="nav-header">Test Server</li>
                              
      <li>
  
                          <a href="http://fhirtest.uhn.ca" class="externalLink" title="Public Test Server">
          <i class="none"></i>
        Public Test Server</a>
            </li>
                
      <li>
  
                          <a href="doc_vagrant.html" title="Vagrant (Private) Test Server">
          <i class="none"></i>
        Vagrant (Private) Test Server</a>
            </li>
                              <li class="nav-header">Documentation</li>
                              
      <li>
  
                          <a href="doc_intro.html" title="Introduction">
          <i class="none"></i>
        Introduction</a>
            </li>
                                                                                                                  
      <li>
  
                          <a href="doc_fhirobjects.html" title="The Data Model">
          <i class="icon-chevron-down"></i>
        The Data Model</a>
                    <ul class="nav nav-list">
                    
      <li>
  
                          <a href="doc_extensions.html" title="Profiles & Extensions">
          <i class="none"></i>
        Profiles & Extensions</a>
            </li>
                    
      <li>
  
                          <a href="doc_resource_references.html" title="Resource References">
          <i class="none"></i>
        Resource References</a>
            </li>
                    
      <li>
  
                          <a href="doc_tags.html" title="Tags">
          <i class="none"></i>
        Tags</a>
            </li>
                    
      <li>
  
                          <a href="doc_validation.html" title="Validation">
          <i class="none"></i>
        Validation</a>
            </li>
              </ul>
        </li>
                                                            
      <li>
  
                          <a href="doc_rest_client.html" title="RESTful Client">
          <i class="icon-chevron-down"></i>
        RESTful Client</a>
                    <ul class="nav nav-list">
                    
      <li>
  
                          <a href="doc_rest_client_interceptor.html" title="Interceptors (client)">
          <i class="none"></i>
        Interceptors (client)</a>
            </li>
              </ul>
        </li>
                                                                                                                                              
      <li>
  
                          <a href="doc_rest_server.html" title="RESTful Server">
          <i class="icon-chevron-down"></i>
        RESTful Server</a>
                    <ul class="nav nav-list">
                    
      <li>
  
                          <a href="doc_rest_operations.html" title="RESTful Operations">
          <i class="none"></i>
        RESTful Operations</a>
            </li>
                    
      <li>
  
                          <a href="doc_narrative.html" title="Narrative Generator">
          <i class="none"></i>
        Narrative Generator</a>
            </li>
                    
      <li>
  
                          <a href="doc_cors.html" title="CORS Support">
          <i class="none"></i>
        CORS Support</a>
            </li>
                    
      <li class="active">
  
            <a href="#"><i class="none"></i>Interceptors (server)</a>
          </li>
                    
      <li>
  
                          <a href="doc_server_tester.html" title="Web Testing UI">
          <i class="none"></i>
        Web Testing UI</a>
            </li>
              </ul>
        </li>
                
      <li>
  
                          <a href="doc_logging.html" title="Logging">
          <i class="none"></i>
        Logging</a>
            </li>
                
      <li>
  
                          <a href="doc_tinder.html" title="Tinder Plugin">
          <i class="none"></i>
        Tinder Plugin</a>
            </li>
                              <li class="nav-header">Community</li>
                              
      <li>
  
                          <a href="https://groups.google.com/d/forum/hapi-fhir" class="externalLink" title="Google Group">
          <i class="none"></i>
        Google Group</a>
            </li>
                
      <li>
  
                          <a href="https://github.com/jamesagnew/hapi-fhir/issues" class="externalLink" title="Issue Tracker">
          <i class="none"></i>
        Issue Tracker</a>
            </li>
                              <li class="nav-header">JavaDocs</li>
                              
      <li>
  
                          <a href="apidocs/index.html" title="Core API">
          <i class="none"></i>
        Core API</a>
            </li>
                
      <li>
  
                          <a href="apidocs-dstu/index.html" title="Model API (DSTU1)">
          <i class="none"></i>
        Model API (DSTU1)</a>
            </li>
                
      <li>
  
                          <a href="apidocs-dev/index.html" title="Model API (DEV)">
          <i class="none"></i>
        Model API (DEV)</a>
            </li>
                
      <li>
  
                          <a href=".https://github.com/jamesagnew/hapi-fhir" class="externalLink" title="Source Code">
          <i class="none"></i>
        Source Code</a>
            </li>
                              <li class="nav-header">Reports</li>
                              
      <li>
  
                          <a href="team-list.html" title="Developers">
          <i class="none"></i>
        Developers</a>
            </li>
                
      <li>
  
                          <a href="surefire-report.html" title="Unit Test Report">
          <i class="none"></i>
        Unit Test Report</a>
            </li>
                
      <li>
  
                          <a href="findbugs.html" title="FindBugs">
          <i class="none"></i>
        FindBugs</a>
            </li>
                
      <li>
  
                          <a href="license.html" title="License">
          <i class="none"></i>
        License</a>
            </li>
                
      <li>
  
                          <a href="https://github.com/jamesagnew/hapi-fhir" class="externalLink" title="Source Code">
          <i class="none"></i>
        Source Code</a>
            </li>
            </ul>
                
                    
                            <form id="search-form" action="http://www.google.com/search" method="get" >
    
  <input value="hl7api.sourceforge.net/hapi-fhir/" name="sitesearch" type="hidden"/>
  <input class="search-query" name="q" id="query" type="text" />
</form>
<script type="text/javascript" src="http://www.google.com/coop/cse/brand?form=search-form"></script>
          
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                                                                                                                         <a href="https://github.com/jamesagnew/hapi-fhir" title="Hosted on GitHub" class="builtBy">
        <img class="builtBy"  alt="Hosted on GitHub" src="images/github-logo-mini.png"    />
      </a>
                                                                                                          <a href="http://maven.apache.org" title="Built with Maven 3" class="builtBy">
        <img class="builtBy"  alt="Built with Maven 3" src="images/maven-logo-mini.png"    />
      </a>
                      </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span9" >
                                  
            

	

		<!-- The body of the document contains a number of sections -->
		<div class="section">
<h2><a name="Server_Interceptors"></a>Server Interceptors</h2>
			
			
			
<ul>
<li><a href="#Server_Interceptors">Server Interceptors</a>
<ul>
<li><a href="#Exception_Handling">Exception Handling</a></li>
<li><a href="#Registering_Interceptors">Registering Interceptors</a></li></ul></li>
<li><a href="#Built_In_Interceptors">Built In Interceptors</a>
<ul>
<li><a href="#Logging_Server_Requests">Logging Server Requests</a></li></ul></li>
<li><a href="#Creating_Interceptors">Creating Interceptors</a></li></ul>
			
			<img src="svg/restful-server-interceptors.svg" alt="Interceptors" align="right" />
			
			
<p>
				The RESTful server provides a powerful mechanism for adding cross-cutting behaviour
				to each incoming request that it processes. This mechanism consists of defining one or
				more <b>interceptors</b> that will be invoked at defined points in the processing of 
				each incoming request.
			</p>
			
			
<p>
				Interceptors will intercept the incoming request, and can take action such as 
				logging or auditing it, or examining/injecting headers. They can optionally choose 
				to handle the request themself and the cancel any subsequent processing. Interceptors
				may also be notified of responses prior to those responses being served to a client, 
				and may audit or even cancel response. The diagram on the right shows the 
				lifecycle of a normal (non failing) request which is subject to an interceptor.  
			</p>
			
			
<p>
				Interceptors must implement the 
				<a href="./apidocs/ca/uhn/fhir/rest/server/interceptor/IServerInterceptor.html">IServerInterceptor</a>
				interface (or extend the convenience 
				<a href="./apidocs/ca/uhn/fhir/rest/server/interceptor/InterceptorAdapter.html">InterceptorAdapter</a> 
				class provided). The RESTful server will normally invoke the interceptor at three 
				points in the execution of the client request. 
			</p>
			
			
<ul>
				
<li>
					Before any processing at all is performed on the request,
					<b>incomingRequestPreProcessed</b> will be invoked. This can be useful
					if you wish to handle some requests completely outside of HAPI's processing
					mechanism. If you are handling a request in your interceptor, you may
					return <tt>false</tt> from your implementation method to signal to
					HAPI that processing of the request should stop immediately.
				</li>
				
<li>
					Once the request is parsed (but before it is handled),
					<b>incomingRequestPostProcessed</b> will be invoked. This method has
					an additional parameter, the
					<a href="./apidocs/ca/uhn/fhir/rest/method/RequestDetails.html">RequestDetails</a>
					object which contains details about what operation is about to be
					called, and what request parameters were receievd with that request.
				</li>
				
<li>
					After the operation is handled (by invoking the corresponding ResourceProvider or PlainProvider method),
					but before the actual response is returned to the client,
					the <b>outgoingResponse</b> method is invoked.
					This method also has details about the request in its parameters, but also
					receives a copy of the response that is about to be returned. Note that
					there are three implementations of <b>outgoingResponse</b>: The server
					will invoke the one which corresponds to the response type
					of the operation being invoked (resource, bundle, etc.)
				</li>
			</ul>

			<br />
			
<div class="section">
<h3><a name="Exception_Handling"></a>Exception Handling</h3>
			
				<img src="svg/restful-server-interceptors-exception.svg" alt="Interceptors" align="right" />
				
				
<p>
					In the event of an exception being thrown within the server, the interceptor
					method 
					<tt><a href="./apidocs/ca/uhn/fhir/rest/server/interceptor/IServerInterceptor.html#handleExceptionca.uhn.fhir.rest.method.RequestDetails20java.lang.Throwable20javax.servlet.http.HttpServletRequest20javax.servlet.http.HttpServletResponse">handleException</a></tt>
					will be called. This applies both to HAPI-FHIR defined exceptions thrown within resource provider methods 
					you have created as well as unexpected exceptions such as NullPointerException thrown 
					at any point in the handling chain.
				</p>
				
<p>
					In general, you will want to return <tt>true</tt> from the <tt>handleException</tt>
					method, which means that processing continues normally (RestfulServer will return an 
					HTTP 4xx or 5xx response automatically depending on the specific exception which was thrown). 
				</p>
				
<p>
					However, you may override the server's built-in exception handling by returning
					<tt>false</tt>. In this case, you must provide your own response by
					interacting with the <tt>HttpServletResponse</tt> object which is
					passed in.
				</p>
			</div>
			
			<br />
			
<div class="section">
<h3><a name="Registering_Interceptors"></a>Registering Interceptors</h3>
			
				
<p>
					To register an interceptor to the server, simply call
					either <tt>registerInterceptor</tt> or <tt>setInterceptors</tt>
					on your RestfulServer instance.					
				</p>
				
<p>
					Note that order is important: The server will invoke 
					<tt>incomingRequestPreProcessed</tt> and <tt>incomingRequestPostProcessed</tt>
					in the same order that they are registered to the server. The server will
					invoke <tt>outgoingResponse</tt> in the <b>reverse</b> order to the
					order in which the interceptors were registered. This means that interceptors
					can be thought of as &quot;wrapping&quot; the request.					
				</p>
				
			</div>
			
		</div>

		
<div class="section">
<h2><a name="Built_In_Interceptors"></a>Built In Interceptors</h2>
		
			
<p>
				HAPI also provides built-in interceptors which may be useful. Links to the code for each interceptor
				is also provided, to give examples of how interceptors are written.
			</p>
			
			<a name="Logging"></a>
			
<div class="section">
<h3><a name="Logging_Server_Requests"></a>Logging Server Requests</h3>
			
				
<p>
					The 
					<a href="./apidocs/ca/uhn/fhir/rest/server/interceptor/LoggingInterceptor.html">LoggingInterceptor</a>
					(<a href="./xref/ca/uhn/fhir/rest/server/interceptor/LoggingInterceptor.html">code</a>)
					can be used to generate a new log line (via SLF4j) for each incoming request. LoggingInterceptor
					provides a flexible message format that can be used to provide a customized level
					of detail about each incoming request.
				</p>
				
				
<p>
					The following example shows how to register a logging interceptor within
					a FHIR RESTful server.
				</p>					
				
					
					
				
<div class="source">
<pre>   @WebServlet(urlPatterns = { &quot;/fhir/*&quot; }, displayName = &quot;FHIR Server&quot;)
   public class RestfulServerWithLogging extends RestfulServer {

      @Override
      protected void initialize() throws ServletException {
         
         // ... define your resource providers here ...
         
         // Now register the logging interceptor
         LoggingInterceptor loggingInterceptor = new LoggingInterceptor();
         registerInterceptor(loggingInterceptor);

         // The SLF4j logger &quot;test.accesslog&quot; will receive the logging events 
         loggingInterceptor.setLoggerName(&quot;test.accesslog&quot;);
         
         // This is the format for each line. A number of substitution variables may
         // be used here. See the JavaDoc for LoggingInterceptor for information on
         // what is available.
         loggingInterceptor.setMessageFormat(&quot;Source[${remoteAddr}] Operation[${operationType} ${idOrResourceName}] UA[${requestHeader.user-agent}] Params[${requestParameters}]&quot;);
         
      }
      
   }
</pre></div>
				
				
<p>
					This interceptor will then produce output similar to the following:
				</p>
				
<div class="source">
<pre>2014-09-04 02:37:30.030 Source[127.0.0.1] Operation[vread Patient/1667/_history/1] UA[Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.94 Safari/537.36] Params[?_format=json]
2014-09-04 03:30:00.443 Source[127.0.0.1] Operation[search-type Organization] UA[Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)] Params[]</pre></div>
				
			</div>
			
		</div>
		
		
<div class="section">
<h2><a name="Creating_Interceptors"></a>Creating Interceptors</h2>
		
			
<p>
				Creating your own interceptors is easy. HAPI-FHIR provides a class called
				<tt>InterceptorAdapter</tt> which you can extend and then override any
				methods you wish. The following example shows a simple request counter.
			</p>
			
				
				
			
<div class="source">
<pre>public class RequestCounterInterceptor extends InterceptorAdapter
{

   private int myRequestCount;

   public int getRequestCount() {
      return myRequestCount;
   }

   /**
    * Override the incomingRequestPreProcessed method, which is called
    * for each incoming request before any processing is done
    */
   @Override
   public boolean incomingRequestPreProcessed(HttpServletRequest theRequest, HttpServletResponse theResponse) {
      myRequestCount++;
      return true;
   }
   
}
</pre></div>
		
			
<p>
				The following example shows an exception handling interceptor which
				overrides the built-in exception handling by providing a custom response.
			</p>
			
				
				
			
<div class="source">
<pre>public class RequestExceptionInterceptor extends InterceptorAdapter
{

   @Override
   public boolean handleException(RequestDetails theRequestDetails, Throwable theException, HttpServletRequest theServletRequest,
         HttpServletResponse theServletResponse) throws ServletException, IOException {
      
      // If the exception is a built-in type, it defines the correct status
      // code to return. Otherwise default to 500.
      if (theException instanceof BaseServerResponseException) {
         theServletResponse.setStatus(((BaseServerResponseException) theException).getStatusCode());
      } else {
         theServletResponse.setStatus(Constants.STATUS_HTTP_500_INTERNAL_ERROR);
      }
      
      // Provide a response ourself
      theServletResponse.setContentType(&quot;text/plain&quot;);
      theServletResponse.getWriter().append(&quot;Failed to process!&quot;);
      theServletResponse.getWriter().close();
      
      // Since we handled this response in the interceptor, we must return false
      // to stop processing immediately
      return false;
   }


}
</pre></div>
			
		</div>
		
	


                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                              <p >Copyright &copy;                    2014
                        <a href="http://www.uhn.ca">University Health Network</a>.
            All rights reserved.      
                    
      </p>
        </div>

        
        
                </div>
    </footer>
        <script type="text/javascript">
	var elements = document.getElementsByClassName("source");
	for (var i=0; i < elements.length; i++) {
		var pres = elements[i].getElementsByTagName("pre");
		for (var j = 0; j < pres.length; j++) {
			var pre = pres[j];
			if (pre.innerHTML.match(/\/\*/)) {
				pre.className = 'brush: java';
			} else if (pre.innerHTML.match(/^\/\//)) {
				pre.className = 'brush: java';
			} else if (pre.innerHTML.match(/^\{/)) {
				pre.className = 'brush: jscript';
			} else if (pre.innerHTML.match(/^\#/)) {
				pre.className = 'brush: bash';
			} else if (pre.innerHTML.match(/\&lt\;\//)) {
				pre.className = 'brush: xml';
			} else {
				pre.className = 'brush: java';
			}
		}
	}

	SyntaxHighlighter.all();
</script>
<script type="text/javascript">
	var elements = document.getElementsByClassName("source");
	for (var i=0; i < elements.length; i++) {
		var pres = elements[i].getElementsByTagName("pre");
		for (var j = 0; j < pres.length; j++) {
			var pre = pres[j];
			if (pre.innerHTML.match(/\/\*/)) {
				pre.className = 'brush: java';
			} else if (pre.innerHTML.match(/^\/\//)) {
				pre.className = 'brush: java';
			} else if (pre.innerHTML.match(/^\{/)) {
				pre.className = 'brush: jscript';
			} else if (pre.innerHTML.match(/^\#/)) {
				pre.className = 'brush: bash';
			} else if (pre.innerHTML.match(/\&lt\;\//)) {
				pre.className = 'brush: xml';
			} else {
				pre.className = 'brush: java';
			}
		}
	}

	SyntaxHighlighter.all();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-1395874-5', 'auto');
  ga('require', 'displayfeatures');
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');

</script>
                </body >
</html>