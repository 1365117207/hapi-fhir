<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="description" content="" />
		<meta name="author" content="" />
		<script src="js/jquery-2.1.0.min.js"></script>
		
		<title>RESTful Tester</title>
	
		<script type="text/javascript">
			var conformance = <th:block th:utext="${jsonEncodedConf}"/>;
			var resourceName = '<th:block th:utext="${resourceName}"/>';
		</script>
	
		<!-- Syntaxhighlighter -->
		<script src="shCore.js" type="text/javascript"></script>
		<script src="shBrushJScript.js" type="text/javascript"></script>
		<script src="shBrushXml.js" type="text/javascript"></script>
		<script src="shBrushPlain.js" type="text/javascript"></script>
		<link rel="stylesheet" type="text/css" href="shCore.css"/>
		<link rel="stylesheet" type="text/css" href="shThemeDefault.css"/>
	
		<!-- Bootstrap core CSS -->
		<link href="css/bootstrap.min.css" rel="stylesheet" />
		
		<!-- Custom styles for this template -->
		<link href="css/tester.css" rel="stylesheet" />
		
		<script type="text/javascript" src="js/moment.min.js"></script>
		
		<!-- Datetimepicker Component -->
		<link href="css/bootstrap-datetimepicker.min.css" rel="stylesheet" />
		<script src="js/bootstrap-datetimepicker.min.js"></script>
	
		<!-- Select2 component -->
		<link href="css/select2.css" rel="stylesheet"/>
    	<script src="js/select2.min.js"></script>
    
    	<!-- Fontawesome -->
		<link href="fa/css/font-awesome.min.css" rel="stylesheet" />
		    
	</head>

<body>
	<form action="" method="get" id="outerForm">

		<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
			<div class="container-fluid">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle" data-toggle="collapse"
						data-target=".navbar-collapse">
						<span class="sr-only">Toggle navigation</span> <span
							class="icon-bar"></span> <span class="icon-bar"></span> <span
							class="icon-bar"></span>
					</button>
					<a class="navbar-brand" th:href="'?encoding=' + ${encoding} + '&amp;pretty=' + ${pretty}">
						HAPI FHIR RESTful Server
					</a>
					<a class="navbar-left navbarBreadcrumb" th:if="${resourceName.empty} == false" th:href="'?encoding=' + ${encoding} + '&amp;pretty=' + ${pretty} + '&amp;resource=' + ${resourceName}">
						<span class="glyphicon glyphicon-chevron-right"></span>
						<span th:text="'Resource[' + ${resourceName} + ']'"></span>
					</a>
					<div class="navbar-left navbarBreadcrumb" th:if="${outcomeDescription} != null">
						<span class="glyphicon glyphicon-chevron-right"></span>
						<span th:text="${outcomeDescription}"></span>
					</div>
				</div>
				<div class="navbar-collapse collapse">
					<ul class="nav navbar-nav navbar-right">
						<li><a href="#">Help</a></li>
					</ul>
				</div>
			</div>
		</div>

		<div class="container-fluid">
			<div class="row">

				<div class="col-sm-3 col-md-3 sidebar">

					<h4>Options</h4>

					<label class="navBarButtonLabel">Encoding</label>
					<div class="btn-group " data-toggle="buttons" id="encodingBtnGroup">
						<label class="btn btn-sm btn-default active"> <input
							type="radio" name="encoding" id="encode-default" value="" />(default)
						</label> <label class="btn btn-sm btn-default"> <input
							type="radio" name="encoding" id="encode-xml" value="xml" />XML
						</label> <label class="btn btn-sm btn-default"> <input
							type="radio" name="encoding" id="encode-json" value="json" />JSON
						</label>
					</div>

					<br /> <label class="navBarButtonLabel">Pretty</label>
					<div class="btn-group top-buffer" data-toggle="buttons">
						<label class="btn btn-sm btn-default active"> <input
							type="radio" name="pretty" id="pretty-default" value="" />(default)
						</label> <label class="btn btn-sm btn-default"> <input
							type="radio" name="pretty" id="pretty-true" value="true" />On
						</label> <label class="btn btn-sm btn-default"> <input
							type="radio" name="pretty" id="pretty-false" value="false" />Off
						</label>
					</div>

					<script type="text/javascript">
					$( document ).ready(function() {
						<th:block th:switch="${encoding}">
							<th:block th:case="'xml'">
								$('#encode-xml').trigger("click");
							</th:block>
							<th:block th:case="'json'">
								$('#encode-json').trigger("click");
							</th:block>
						</th:block>
						<th:block th:switch="${pretty}">
							<th:block th:case="'true'">
								$('#pretty-true').trigger("click");
							</th:block>
							<th:block th:case="'false'">
								$('#pretty-false').trigger("click");
							</th:block>
						</th:block>
					});
					
					function doAction(source, action, resourceName) {
						var abtn = $('<input />', { type: 'hidden', name: 'action', value: action });
						$(source).append(abtn);
						if (resourceName != null) {
							var rbtn = $('<input />', { type: 'hidden', name: 'resource', value: resourceName });
							$(source).append(rbtn);
						} else {
							var resource = $('#resource');
							if (resource) {
								resource.val('');
							}
						}
						$('#outerForm').submit();
					}
					</script>

					<h4>Query Mode</h4>

					<ul class="nav nav-sidebar">
						<li th:class="${resourceName.empty} ? 'active' : ''">
							<a href="#" onclick="doAction(this, 'home', null);">RESTful Server</a>
						</li>
						<th:block
							th:each="resource, resIterStat : ${conf.restFirstRep.resource}">
							<li th:class="${resourceName} == ${resource.type.valueAsString} ? 'active' : ''">
								<a href="#" th:onclick="'doAction(this, \'home\', \'' + ${resource.type.valueAsString} + '\');'">
									<th:block th:text="${resource.type.valueAsString}" >Patient</th:block>
									<span class="badge" th:if="${resourceCounts[resource.type.valueAsString]} != null" th:text="${resourceCounts[resource.type.valueAsString]}"/>
								</a>
							</li>
						</th:block>
					</ul>
					
					<input th:if="${resourceName.empty} == false" type="hidden" id="resource" name="resource" th:value="${resourceName}"/>
				
				</div>


				<div class="col-sm-9 col-sm-offset-3 col-md-9 col-md-offset-3 main">

					<div class="row">
						<div class="col-md-8">
							<img src="img/hapi_fhir_banner.png" />
						</div>
						<div class="col-md-4">
							<img src="img/hapi_fhir_banner_right.png" align="right" />
						</div>
					</div>

					<div class="alert  alert-danger alert-dismissable" th:if="${errorMsg} != null">
						<strong>Warning!</strong>
						<p th:text="${errorMsg}"></p>
					</div>

					<!-- ********************************************************** -->
					<!-- ** Default Home                                         ** -->
					<!-- ********************************************************** -->

					<div th:if="${requestUrl} == null">
						<div class="well">
							This is a RESTful server tester, which can be used to send
							requests to, and receive responses from the server at the
							following URL: <a href="http://foo.com/fhir" th:href="${base}"
								th:text="${base}">http://foo.com/fhir</a>
						</div>

						<table class="table table-bordered table-striped">
							<colgroup>
								<col class="col-xs-1" />
								<col class="col-xs-7" />
							</colgroup>
							<tbody>
								<tr>
									<td>Software</td>
									<td th:text="${conf.software.name}">HAPI Restful Server</td>
								</tr>
								<tr>
									<td>Version</td>
									<td th:text="${conf.software.version}">1.1.1</td>
								</tr>
							</tbody>
						</table>

						<!-- ************************************************ -->
						<!-- ** Server Actions (no resource selected)      ** -->
						<!-- ************************************************ -->

						<div class="panel panel-default" th:if="${resourceName.empty}">
							<div class="panel-heading">
								<h3 class="panel-title">Server Actions</h3>
							</div>
							<div class="panel-body">
								<div class="container-fluid">
							
								<!-- Conformance -->
								
									<div class="row-fluid">
										Retrieve the server's <b>conformance</b> statement.										
									</div>
								    <div class="row-fluid">
								    	<div class="col-sm-2">
											<button type="submit" id="fetch-conformance-btn"
												data-loading-text="Loading..." class="btn btn-primary btn-block"
												name="action" value="conformance">Conformance</button>
											<script type="text/javascript">
												$('#fetch-conformance-btn').click(
														function() {
															var btn = $(this);
															btn.button('loading');
														});
											</script>
										</div>
									</div>
									
								<!-- Server History -->
								
									<br clear="all"/>
									<div class="row-fluid">
										Retrieve the update <b>history</b> across all resource types on
										the server.										
									</div>
								    <div class="row-fluid top-buffer">
								    	<div class="col-sm-2">
										<button type="submit" id="server-history-btn"
											data-loading-text="Loading..." class="btn btn-primary btn-block"
											name="action" value="history-server">Server History</button>
								    	</div>
								        <div class='col-sm-5'>
								            <div class="form-group">
								                <div class='input-group date' id='server-history-datetime' data-date-format="YYYY-MM-DDTHH:mm:ss">
								                    <div class="input-group-addon">
								                    Since
								                    </div>
								                    <input type='text' class="form-control" id="server-history-since"/>
								                    <div class="input-group-addon">
								                    <span class="glyphicon glyphicon-calendar"></span>
								                    </div>
								                </div>
								            </div>
								        </div>								        
										<div class='col-sm-3'>
								            <div class="form-group">
								                <div class='input-group'>
								                    <div class="input-group-addon">
								                    Limit #
								                    </div>
								                    <input type="text" class="form-control" id="server-history-limit" placeholder="(opt)"/>
								                </div>
								            </div>
								        </div>
								        <script type="text/javascript">
								            $(function () {
								                $('#server-history-datetime').datetimepicker({
								                	sideBySide: true,
								                	use24hours: true,
								                	showToday: true
								                });
								            });
								            $('#server-history-btn').click(
												function() {
													var btn = $(this);
													btn.button('loading');
													var limit = $('#server-history-limit').val();
													if (limit != null) btn.append($('<input />', { type: 'hidden', name: 'limit', value: limit }));
													var since = $('#server-history-since').val();
													if (since != null) btn.append($('<input />', { type: 'hidden', name: 'since', value: since }));
												});								            
								        </script>
								        
								    </div>
								    
								<!-- Get Tags -->
								
									<br clear="all"/>
									<div class="row-fluid">
										Show all of the tags currently in use on the server										
									</div>
								    <div class="row-fluid">
								    	<div class="col-sm-2">
											<button type="submit" id="get-server-tags-btn"
												data-loading-text="Loading..." class="btn btn-primary btn-block"
												name="action" value="get-tags">Get Tags</button>
											<script type="text/javascript">
												$('#get-server-tags-btn').click(
														function() {
															var btn = $(this);
															btn.button('loading');
														});
											</script>
										</div>
									</div>

								<!-- Next Server Action? -->
								    
								</div>
							</div>
						</div>

						<!-- ************************************************ -->
						<!-- ** Resource Actions                           ** -->
						<!-- ************************************************ -->
						
						<div class="panel panel-default" th:if="${resourceName.empty} == false">
							<div class="panel-heading">
								<h3 class="panel-title" th:text="'Resource: ' + ${resourceName}">Resource: <b>Patient</b></h3>
							</div>
							<div class="panel-body">
								This page contains various operations for interacting with
								the <th:block th:text="${resourceName}"/> resource.
							</div>
						</div>
						
						<div class="panel panel-default" th:if="${resourceName.empty} == false">
							<div class="panel-heading">
								<h3 class="panel-title">Search</h3>
							</div>
							<div class="panel-body">
								<div class="container-fluid">
									<div class="row-fluid">
								    	<div class="col-sm-2">
											<button type="submit" id="search-btn" class="btn btn-primary btn-block" name="action" value="search">
												<span class="glyphicon glyphicon-search"></span>
												Search
											</button>
										</div>												
									</div>
									<br clear="all"/>
									
									<div class="row-fluid">
										<h4>Search Parameters <small>Optionally add parameter(s) to the search</small></h4>
									</div>
									
									<div id="search-param-rows" style="padding-left: 15px;">
										<!-- Placeholder: gets populated by script below -->
									</div>
									
									<div class="row-fluid">
										<h4>Includes <small>Also load and include referenced resources in results</small></h4>
									</div>
									
									<div class="row-fluid">
										<span th:each="include : ${includes}" class="includeCheckContainer">
											<span class="includeCheckCheck">
				                    			<input type="checkbox" name="_include" th:value="${include}" th:id="'inc_' + ${include}" />
				                    		</span>
											<span class="includeCheckName" th:text="${include}"/>
				                    	</span>
									</div>

									<div class="row-fluid">
										<h4>Other Options</h4>
									</div>
									
									<div class="row-fluid">
										<div class='col-sm-3'>
								            <div class="form-group">
								                <div class='input-group date'>
								                    <div class="input-group-addon">
								                    Limit
								                    </div>
								                    <input type="text" class="form-control" name="resource-search-limit" placeholder="max # returned"/>
								                </div>
								            </div>
								        </div>
									</div>
																		
									<!-- 
							    	<div class="col-sm-1">
										<button type="button" class="btn btn-success btn-block">Add
											<span class="glyphicon glyphicon-plus"></span>
										</button>
									</div>
									 -->
									<br clear="all"/>
									 
								</div>						
							</div>
						</div>
						<script type="text/javascript">
						/*
							$('#search-btn').click(
							function() {
								$(this).html('<i class="fa fa-cog fa-spin"></i> Searching...')
								//btn.button('loading');
							});
						*/
						
							var numRows = 0;
							function addSearchParamRow() {
								var nextRow = numRows++;
								var select = $('<select/>', {/*style:'margin-left:30px;'*/});
								var plusBtn = $('<button />', {type:'button', 'class':'btn btn-success btn-block'});
								plusBtn.append($('<span />', {'class':'glyphicon glyphicon-plus'}));
								plusBtn.isAdd = true;

								var rowDiv = $('<div />', { 'class': 'row top-buffer', id: 'search-param-row-' + nextRow }).append(
										$('<div />', { 'class': 'col-sm-1' }).append(plusBtn),
										$('<div />', { 'class': 'col-sm-5' }).append(select),
										$('<div />', { id: 'search-param-rowopts-' + nextRow })
								);
								$("#search-param-rows").append(rowDiv);
								
								plusBtn.click(function() {
									addSearchParamRow();
								});
								
								var params = new Array();
								conformance.rest.forEach(function(rest){
									rest.resource.forEach(function(restResource){
										if (restResource.type == resourceName) {
											if (restResource.searchParam) {
												restResource.searchParam.forEach(function(searchParam){
													params[searchParam.name] = searchParam;
													select.append(
														$('<option />', { value: searchParam.name }).text(searchParam.name + ' - ' + searchParam.documentation)														
													);
												});
											}
										}				
									});
								});	
								select.select2();
								handleSearchParamTypeChange(select, params, nextRow);
								select.change(function(){ handleSearchParamTypeChange(select, params, nextRow); });
							}
							
							function handleSearchParamTypeChange(select, params, rowNum) {
								var oldVal = select.prevVal;
								var newVal = select.val();
								if (oldVal == newVal) {
									return;
								}
								$('#search-param-rowopts-' + rowNum).empty();
								var searchParam = params[newVal];
								$('#search-param-rowopts-' + rowNum).append(
						    		$('<input />', { name: 'param.' + rowNum + '.name', type: 'hidden', value: searchParam.name }),
						    		$('<input />', { name: 'param.' + rowNum + '.type', type: 'hidden', value: searchParam.type })
						    	);
						    	
							    if (searchParam.type == 'token') {
							    	$('#search-param-rowopts-' + rowNum).append(
							    		$('<div />', { 'class': 'col-sm-3' }).append(
									    	$('<input />', { name: 'param.' + rowNum + '.0', placeholder: 'system/namespace', type: 'text', 'class': 'form-control' })
									    ),
							    		$('<div />', { 'class': 'col-sm-3' }).append(
									    	$('<input />', { name: 'param.' + rowNum + '.1', type: 'hidden', value: '|' }),
									    	$('<input />', { name: 'param.' + rowNum + '.2', placeholder: 'value', type: 'text', 'class': 'form-control' })
									    )
							    	);
							    } else if (searchParam.type == 'string' || searchParam.type == 'number') {
							    	$('#search-param-rowopts-' + rowNum).append(
							    		$('<div />', { 'class': 'col-sm-3' }).append(
									    	$('<input />', { name: 'param.' + rowNum + '.0', placeholder: 'value', type: 'text', 'class': 'form-control' })
								    	)
								    );
							    } else if (searchParam.type == 'date') {
							    	if (/date$/.test(searchParam.name)) {
										var input = $('<div />', { 'class':'input-group date', 'data-date-format':'YYYY-MM-DD' }).append(
											$('<input />', { type:'text', 'class':'form-control', name: 'param.' + rowNum + '.1' }),
											$('<div />', { 'class':'input-group-addon'}).append(
												$('<span />', { 'class':'glyphicon glyphicon-calendar'})
											)
										);
						                input.datetimepicker({
						                	pickTime: false,
						                	showToday: true
						                });
							    	} else {
										var input = $('<div />', { 'class':'input-group date', 'data-date-format':'YYYY-MM-DDTHH:mm:ss' }).append(
											$('<input />', { type:'text', 'class':'form-control', name: 'param.' + rowNum + '.1' }),
											$('<div />', { 'class':'input-group-addon'}).append(
												$('<span />', { 'class':'glyphicon glyphicon-calendar'})
											)
										);
						                input.datetimepicker({
						                	sideBySide: true,
						                	use24hours: true,
						                	showToday: true
						                });
							    	}

							    	$('#search-param-rowopts-' + rowNum).append(
							    		$('<div />', { 'class': 'col-sm-2 btn-group' }).append(
						    				$('<select />', {type:'text', name:'param.'+rowNum+'.0', 'class':'form-control', autocomplete:'off'}).append(
						    					$('<option value="">(qualifier)</option>'),
						    					$('<option value="=">=</option>'),
						    					$('<option value=">=">&gt;=</option>'),
						    					$('<option value=">">&gt;</option>'),
						    					$('<option value="&lt;=">&lt;=</option>'),
						    					$('<option value="&lt;">&lt;</option>')
						    				)
								    	),							    			
							    		$('<div />', { 'class': 'col-sm-4' }).append(
									    	input
								    	)
								    );
							    }
								
								select.prevVal = newVal;
							}
							
							$( document ).ready(function() {
								addSearchParamRow();
							});							
						</script>
						
						<div class="panel panel-default" th:if="${resourceName.empty} == false">
							<div class="panel-heading">
								<h3 class="panel-title">Operations</h3>
							</div>
							<div class="panel-body">
								<div class="container-fluid">

								<!-- Read/VRead -->
								
									<div class="row-fluid">
										<div>
											<b>Read</b> an individual resource instance given its
											ID (and optionally a version ID to retrieve a specific version
											of that instance to <b>vread</b> that instance)
										</div>										
									</div>
								    <div class="row-fluid">
								    	<div class="col-sm-2">
											<button type="submit" id="read-btn"
												data-loading-text="Loading..." class="btn btn-primary btn-block"
												name="action" value="read">Read</button>
										</div>												
										<div class='col-sm-3'>
								            <div class="form-group">
								                <div class='input-group date'>
								                    <div class="input-group-addon">
								                    ID
								                    <span class="loadingStar">*</span>
								                    </div>
								                    <input type="text" class="form-control" id="read-id"/>
								                </div>
								            </div>
								        </div>											
										<div class='col-sm-4'>
								            <div class="form-group">
								                <div class='input-group date'>
								                    <div class="input-group-addon">
								                    Version ID
								                    </div>
								                    <input type="text" class="form-control" id="read-vid" placeholder="(add for vread)"/>
								                </div>
								            </div>
								        </div>											
										<script type="text/javascript">
											$('#read-btn').click(
												function() {
													var btn = $(this);
													btn.button('loading');
													var id = $('#read-id').val();
													if (id != null) btn.append($('<input />', { type: 'hidden', name: 'id', value: id }));
													var vid = $('#read-vid').val();
													if (vid != null) btn.append($('<input />', { type: 'hidden', name: 'vid', value: vid }));
													btn.append($('<input />', { type: 'hidden', name: 'resource', value: '<th:block th:text="${resourceName}"/>' }));
												});
										</script>
									</div>
									<br clear="all"/>
									
								<!-- Resource History -->
								
									<div class="row-fluid">
										Retrieve the update <b>history</b> across the <th:block th:text="${resourceName}"/> 
										resource type, or against a specific instance of this resource type if
										an ID is specified. 			
									</div>
								    <div class="row-fluid top-buffer">
								    	<div class="col-sm-2">
											<button type="submit" id="resource-history-btn"
												data-loading-text="Loading..." class="btn btn-primary btn-block"
												name="action" value="history-resource">History</button>
								    	</div>
										<div class='col-sm-3'>
								            <div class="form-group">
								                <div class='input-group date'>
								                    <div class="input-group-addon">
								                    ID
								                    </div>
								                    <input type="text" class="form-control" id="resource-history-id" placeholder="(instance ID)"/>
								                </div>
								            </div>
								        </div>											
								        <div class='col-sm-5'>
								            <div class="form-group">
								                <div class='input-group date' id='resource-history-datetime' data-date-format="YYYY-MM-DDTHH:mm:ss">
								                    <div class="input-group-addon">
								                    Since
								                    </div>
								                    <input type='text' class="form-control" id="resource-history-since" placeholder="(opt)"/>
								                    <div class="input-group-addon">
								                    <span class="glyphicon glyphicon-calendar"></span>
								                    </div>
								                </div>
								            </div>
								        </div>								        
										<div class='col-sm-2'>
								            <div class="form-group">
								                <div class='input-group date'>
								                    <div class="input-group-addon">
								                    Limit
								                    </div>
								                    <input type="text" class="form-control" id="resource-history-limit" placeholder="(#)"/>
								                </div>
								            </div>
								        </div>
								        <script type="text/javascript">
								            $(function () {
								                $('#resource-history-datetime').datetimepicker({
								                	sideBySide: true,
								                	use24hours: true,
								                	showToday: true
								                });
								            });
								            $('#resource-history-btn').click(
												function() {
													var btn = $(this);
													btn.button('loading');
													var limit = $('#resource-history-limit').val();
													if (limit != null) btn.append($('<input />', { type: 'hidden', name: 'limit', value: limit }));
													var since = $('#resource-history-since').val();
													if (since != null) btn.append($('<input />', { type: 'hidden', name: 'since', value: since }));
													var id = $('#resource-history-id').val();
													if (id != null) btn.append($('<input />', { type: 'hidden', name: 'resource-history-id', value: id }));
												});								            
								        </script>								        
								    </div>
									<br clear="all"/>
																	
								<!-- Delete -->
								
									<div class="row-fluid">
										<b>Delete</b> an individual instance of the resource 			
									</div>
								    <div class="row-fluid top-buffer">
								    	<div class="col-sm-2">
											<button type="submit" id="resource-delete-btn"
												data-loading-text="Loading..." class="btn btn-primary btn-block"
												name="action" value="delete">Delete</button>
								    	</div>
										<div class='col-sm-3'>
								            <div class="form-group">
								                <div class='input-group date'>
								                    <div class="input-group-addon">
								                    ID
								                    <span class="loadingStar">*</span>
								                    </div>
								                    <input type="text" class="form-control" id="resource-delete-id"/>
								                </div>
								            </div>
								        </div>											
								        <script type="text/javascript">
								            $('#resource-delete-btn').click(
												function() {
													var btn = $(this);
													btn.button('loading');
													var id = $('#resource-delete-id').val();
													if (id != null) btn.append($('<input />', { type: 'hidden', name: 'resource-delete-id', value: id }));
												});								            
								        </script>								        
								    </div>
									<br clear="all"/>
																	
								<!-- Create/Update -->
								
									<div class="row-fluid">
										<b>Create/Update</b> an instance of the resource. If no ID is specified, 
										a new resource will be created. If an ID is specified, the existing
										resource with that ID will be updated.
									</div>
								    <div class="row-fluid top-buffer">
								    	<div class="col-sm-2">
											<button type="submit" id="resource-create-btn"
												data-loading-text="Loading..." class="btn btn-primary btn-block"
												name="action" value="create">Create</button>
								    	</div>
										<div class='col-sm-3'>
								            <div class="form-group">
								                <div class='input-group date'>
								                    <div class="input-group-addon">
								                    ID
								                    </div>
								                    <input type="text" class="form-control" id="resource-create-id" placeholder="(add for update)" th:value="${#strings.defaultString(updateResourceId,'')}"/>
								                </div>
								            </div>
								        </div>											
										<div class='col-sm-7'>
								            <div class="form-group">
								                <div class='input-group date'>
								                    <div class="input-group-addon">
								                    Contents
								                    <span class="loadingStar">*</span>
								                    </div>
								                    <textarea class="form-control" id="resource-create-body" style="white-space: nowrap; overflow: auto;" placeholder="(place resource body here)" rows="1">
								                    	<th:block th:if="${updateResource} != null" th:text="${updateResource}"/>
								                    </textarea>
								                </div>
								            </div>
								        </div>											
								        <script type="text/javascript">
											var buttonChanger = function() {
								        		var val = $('#resource-create-id').val();
								        		if (val != "") {
								        			//$('#resource-create-btn').text("Update");
								        			$("#resource-create-btn").fadeOut(function() {
								        				  $(this).text("Update").fadeIn();
								        			});
								        		} else {
								        			$("#resource-create-btn").fadeOut(function() {
								        				  $(this).text("Create").fadeIn();
								        			});
								        			//$('#resource-create-btn').text("Create");
								        		}
								        	};
							        		var textAreaChanger = function() {
							        			createBodyOriginalHeight = $('#resource-create-body').height();
							        			$('#resource-create-body').animate({height: "200px"}, 500);
							        		}								        	
								        	$('#resource-create-id').change(buttonChanger);
								        	$('#resource-create-id').keyup(buttonChanger);
								        	$('#resource-create-body').focus(textAreaChanger);
								        	/*$('#resource-create-body').blur(
								        		function() {
								        			$('#resource-create-body').animate({height: "34px"}, 500);
								        		});*/
								            $('#resource-create-btn').click(
												function() {
													var btn = $(this);
													btn.button('loading');
													var id = $('#resource-create-id').val();
													if (id != null) btn.append($('<input />', { type: 'hidden', name: 'resource-create-id', value: id }));
													var body = $('#resource-create-body').val();
													btn.append($('<input />', { type: 'hidden', name: 'resource-create-body', value: body }));
												});		
											$( document ).ready(function() {
												if ($('#resource-create-id').val() != "") {
													buttonChanger();
													textAreaChanger();
													$('#resource-create-body').focus();
												}
											});
								        </script>								        
								    </div>
									<br clear="all"/>

								<!-- Validate -->
								
									<div class="row-fluid">
										<b>Validate</b> an instance of the resource to check whether it
										would be acceptable for creating/updating, without actually
										storing it on the server.
									</div>
								    <div class="row-fluid top-buffer">
								    	<div class="col-sm-2">
											<button type="submit" id="resource-validate-btn"
												data-loading-text="Loading..." class="btn btn-primary btn-block"
												name="action" value="validate">Validate</button>
								    	</div>
										<div class='col-sm-10'>
								            <div class="form-group">
								                <div class='input-group date'>
								                    <div class="input-group-addon">
								                    Contents
								                    <span class="loadingStar">*</span>
								                    </div>
								                    <textarea class="form-control" id="resource-validate-body" style="white-space: nowrap; overflow: auto;" placeholder="(place resource body here)" rows="1"></textarea>
								                </div>
								            </div>
								        </div>											
								        <script type="text/javascript">
								        	$('#resource-validate-body').focus(
								        		function() {
								        			validateBodyOriginalHeight = $('#resource-validate-body').height();
								        			$('#resource-validate-body').animate({height: "200px"}, 500);
								        		});
								            $('#resource-validate-btn').click(
												function() {
													var btn = $(this);
													btn.button('loading');
													var body = $('#resource-validate-body').val();
													btn.append($('<input />', { type: 'hidden', name: 'resource-validate-body', value: body }));
												});								            
								        </script>								        
								    </div>

								<!-- Get Tags -->
								
									<br clear="all"/>
									<div class="row-fluid">
										Show all of the tags currently in use on the server for this resource type. If an ID is specified,
										returns only tags posted to the given version. If an ID and a version are specified, 
										returns only the tags posted to the given resource version.									
									</div>
								    <div class="row-fluid">
								    	<div class="col-sm-2">
											<button type="submit" id="get-resource-tags-btn"
												data-loading-text="Loading..." class="btn btn-primary btn-block"
												name="action" value="get-tags">Get Tags</button>
										</div>
										<div class='col-sm-3'>
								            <div class="form-group">
								                <div class='input-group date'>
								                    <div class="input-group-addon">
								                    ID
								                    </div>
								                    <input type="text" class="form-control" id="resource-tags-id" placeholder="(instance ID)"/>
								                </div>
								            </div>
								        </div>																					
										<div class='col-sm-3'>
								            <div class="form-group">
								                <div class='input-group date'>
								                    <div class="input-group-addon">
								                    VID
								                    </div>
								                    <input type="text" class="form-control" id="resource-tags-vid" placeholder="(version)"/>
								                </div>
								            </div>
								        </div>																					
										<script type="text/javascript">
											$('#get-resource-tags-btn').click(
												function() {
													var btn = $(this);
													btn.button('loading');
													var id = $('#resource-tags-id').val();
													if (id != null) btn.append($('<input />', { type: 'hidden', name: 'resource-tags-id', value: id }));
													var vid = $('#resource-tags-vid').val();
													if (vid != null) btn.append($('<input />', { type: 'hvidden', name: 'resource-tags-vid', value: vid }));
											});
										</script>
									</div>

								</div>								
							</div>
						</div>
						
					</div>

					<!-- *************************************************** -->
					<!-- ** Response                                      ** -->
					<!-- *************************************************** -->

					<div th:if="${requestUrl} != null">
						
						<div class="well" id="resultWell">
							Executed request against FHIR RESTful server in 
							<th:block th:text="${latencyMs} + 'ms'"/>
						</div>

						<table class="table table-bordered table-striped requestTable" id="requestTable">
							<colgroup>
								<col class="col-xs-1" />
								<col class="col-xs-7" />
							</colgroup>
							<tbody>
								<tr>
									<td style="white-space: nowrap;">
										<span class="glyphicon glyphicon glyphicon-chevron-right"></span>
										Request
									</td>
									<td>
										<th:block th:text="${action}"/>
										<a th:href="${requestUrl}" th:text="${requestUrl}"/>
									</td>
								</tr>
								<tr th:if="${requestHeaders.length} > 0">
									<td>Request Headers</td>
									<td class="headerBox">
										<div th:each="header : ${requestHeaders}">
											<span class="headerName" th:text="${header.name} + ': '"/>
											<span class="headerValue" th:text="${header.value}"/>
										</div>
									</td>
								</tr>
								<tr th:if="${#strings.isEmpty(requestBody)} == false">
									<td>Request Body</td>
									<td valign="top" style="margin: 0px; padding: 0px;">
										<pre class="requestBodyPre resultBodyPlaceholder" id="requestBodyPlaceholder">...loading...</pre>
										<pre th:text="${requestBody}" th:class="${requestSyntaxHighlighterClass} + ' resultBodyPre pre'" id="requestBodyActual" style="display: none;">{}</pre>
									</td>
								</tr>
							</tbody>
						</table>

						<table class="table table-bordered table-striped resultTable" id="resultTable">
							<colgroup>
								<col class="col-xs-1" />
								<col class="col-xs-7" />
							</colgroup>
							<tbody>
								<tr>
									<td style="white-space: nowrap;">
										<span class="glyphicon glyphicon glyphicon-chevron-left"></span>
										Response
									</td>
									<td th:text="${resultStatus}">HTTP 200 OK</td>
								</tr>
								<tr>
									<td>Response Headers</td>
									<td class="headerBox">
										<div th:each="header : ${responseHeaders}">
											<span class="headerName" th:text="${header.name} + ': '"/>
											<span class="headerValue" th:text="${header.value}"/>
										</div>
									</td>
								</tr>
								<tr th:if="${!#strings.isEmpty(resultBody)}">
									<td rowspan="2">
										Result Body
										<small th:text="${resultDescription}" style="font-weight: normal;"/>
									</td>
									<td style="border-width: 0px; padding: 0px;">
														
										<!-- 
										If the response is a bundle, this block will contain a collapsible
										table with a summary of each entry as well as paging buttons and
										controls for viewing/editing/etc results
										-->															
										<div th:if="${bundle} != null" class="panel-group" id="accordion" style="margin-bottom: 0px;">
											<div class="panel panel-default">
												<div class="panel-heading">
													<h4 class="panel-title">
														<a data-toggle="collapse" data-parent="#accordion" href="#collapseOne">
															<i id="collapseOneIcon" class="fa fa-minus-square-o"></i>
															<span th:text="'Bundle contains ' + ${bundle.entries.size} + ' entries'"/>
														</a>

														<!-- Prev/Next Page Buttons -->
														<button	class="btn btn-success btn-sm" type="submit" id="page-prev-btn"	name="action" value="page" style="margin-left: 15px;">
															<span class="glyphicon glyphicon-step-backward"></span>
															Prev Page
														</button>
														<script type="text/javascript">
															if (<th:block th:text="${bundle.linkPrevious.empty}"/>) {
																$('#page-prev-btn').prop('disabled', true);
															}
															$('#page-prev-btn').click(function() {
																var btn = $(this);
																btn.button('loading');
																btn.append($('<input />', { type: 'hidden', name: 'pageUrl', value: '<th:block th:text="${bundle.linkPrevious}"/>' }));
															});
														</script>

														<button	class="btn btn-success btn-sm" type="submit" id="page-next-btn"	name="action" value="page">
															<span class="glyphicon glyphicon-step-forward"></span>
															Next Page
														</button>
														<script type="text/javascript">
															if (<th:block th:text="${bundle.linkNext.empty}"/>) {
																$('#page-next-btn').prop('disabled', true);
															}
															$('#page-next-btn').click(function() {
																var btn = $(this);
																btn.button('loading');
																btn.append($('<input />', { type: 'hidden', name: 'pageUrl', value: '<th:block th:text="${bundle.linkNext}"/>' }));
															});
														</script>
														
													</h4>
												</div>
												<div id="collapseOne" class="panel-collapse collapse in">
													<div class="panel-body" style="padding-bottom: 0px;">
														<table class="table table-condensed" style="padding-bottom: 0px; margin-bottom: 0px;">
															<tr th:each="entry : ${bundle.entries}">
																<td>
																	<button class="btn btn-primary btn-xs" th:onclick="'readFromEntriesTable(this, \'' + ${entry.resource.id.resourceType} + '\', \'' + ${entry.resource.id.idPart} + '\', \'' + ${entry.resource.id.versionIdPart} + '\');'" type="submit" name="action" value="read">Read</button>
																	<button class="btn btn-primary btn-xs" th:onclick="'updateFromEntriesTable(this, \'' + ${entry.resource.id.resourceType} + '\', \'' + ${entry.resource.id.idPart} + '\', \'' + ${entry.resource.id.versionIdPart} + '\');'" type="submit" name="action" value="home">Update</button>
																</td>
																<td th:text="${entry.title}">
																</td>
															</tr>
														</table>										
														<script type="text/javascript">
															function readFromEntriesTable(source, type, id, vid) {
																var btn = $(source);
																var resId = source.resourceid;
																btn.append($('<input />', { type: 'hidden', name: 'id', value: id }));
																var resVid = source.resourcevid;
																if (resVid != '') {
																	btn.append($('<input />', { type: 'hidden', name: 'vid', value: vid }));
																}
																btn.append($('<input />', { type: 'hidden', name: 'resource', value: type }));
															}															
															function updateFromEntriesTable(source, type, id, vid) {
																var btn = $(source);
																var resId = source.resourceid;
																btn.append($('<input />', { type: 'hidden', name: 'update-id', value: id }));
																var resVid = source.resourcevid;
																if (resVid != '') {
																	btn.append($('<input />', { type: 'hidden', name: 'update-vid', value: vid }));
																}
																btn.append($('<input />', { type: 'hidden', name: 'resource', value: type }));
															}															
														</script>
													</div>
												</div>
												<script type="text/javascript">
													$('#collapseOne').on('hidden.bs.collapse', function () {
													   $("#collapseOneIcon").removeClass("fa-minus-square-o").addClass("fa-plus-square-o");
													});
	
													$('#collapseOne').on('shown.bs.collapse', function () {
													   $("#collapseOneIcon").removeClass("fa-plus-square-o").addClass("fa-minus-square-o");
													});
												</script>
											</div>
										</div>										
										<div class="panel-heading" sstyle="margin: 5px;">
											<h4 class="panel-title">
												Raw Message
												<button th:if="${resultBodyIsLong}" class="btn btn-info btn-sm" type="button" id="format-result-btn">
													<span class="glyphicon glyphicon-eye-open"></span>
													Colour
												</button>
											</h4>										
											<script type="text/javascript" th:if="${resultBodyIsLong}">
<<<<<<< HEAD
												$('#page-next-btn').click(function() {
													var btn = $(this);
													btn.button('loading');
													btn.append($('<input />', { type: 'hidden', name: 'page-url', value: '<th:block th:text="${bundle.linkNext}"/>' }));
=======
												$('#format-result-btn').click(function() {
													//$('#resultBodyActualPre').setClass('<th:block th:text="${resultSyntaxHighlighterClass}"/>');
													document.getElementById('resultBodyActualPre').className='<th:block th:text="${resultSyntaxHighlighterClass}"/>';
													document.getElementById('format-result-btn').disabled ='disabled';
													SyntaxHighlighter.highlight();
													lineWrap();
>>>>>>> 68ea31495cec63706de85e729f19eb863cc835f9
												});
											</script>
										</div>										
									</td>
								</tr>
								<tr th:if="${!#strings.isEmpty(resultBody)}">
									<td valign="top" style="margin: 0px; padding: 0px; font-weight: normal;">
										<pre class="resultBodyPre resultBodyPlaceholder" id="resultBodyPlaceholder">...loading...</pre>
										<div id="resultBodyActual" class="resultBodyActual" style="display: none;">
											<pre id="resultBodyActualPre" th:text="${resultBody}" th:class="(${resultBodyIsLong} ? '' : ${resultSyntaxHighlighterClass}) + ' resultBodyPre pre'">{}</pre>
										</div>
									</td>
								</tr>
								<tr th:if="${!#strings.isEmpty(narrative)}">
									<td class="propertyKeyCell">Result Narrative</td>
									<td th:utext="${narrative}"></td>
								</tr>
							</tbody>
						</table>
						
						<script type="text/javascript"><!--
							$( document ).ready(function() {
								var reswidth = $('#resultBodyPlaceholder').outerWidth(true);
								var reqwidth = 0;
								if ($('#requestBodyPlaceholder') != null) {
									reqwidth = $('#requestBodyPlaceholder').outerWidth(true);
								}
								
								SyntaxHighlighter.all();

								$('#resultBodyPlaceholder').hide();
								$('#resultBodyActual').width(reswidth);
								$('#resultBodyActual').show();
								
								if ($('#requestBodyPlaceholder') != null) {
									$('#requestBodyPlaceholder').hide();
									$('#requestBodyActual').width(reqwidth);
									$('#requestBodyActual').show();
								}
							});
							
							function lineWrap(){
							    var wrap = function () {
							        var elems = document.getElementsByClassName('syntaxhighlighter');
							        for (var j = 0; j < elems.length; ++j) {
							            var sh = elems[j];
							            var gLines = sh.getElementsByClassName('gutter')[0].getElementsByClassName('line');
							            var cLines = sh.getElementsByClassName('code')[0].getElementsByClassName('line');
							            var stand = 15;
							            for (var i = 0; i < gLines.length; ++i) {
							                var h = $(cLines[i]).height();
							                if (h != stand) {
							                    console.log(i);
							                    gLines[i].setAttribute('style', 'height: ' + h + 'px !important;');
							                }
							            }
							        }
							     };
							    var whenReady = function () {
							        if ($('.syntaxhighlighter').length === 0) {
							            setTimeout(whenReady, 800);
							        } else {
							            wrap();
							        }
							    };
							    whenReady();
							};
							lineWrap();
							$(window).resize(function(){lineWrap()});							
						--></script>
						
					</div>


				</div>
			</div>
		</div>

		<!-- Bootstrap core JavaScript
    ================================================== -->
		<!-- Placed at the end of the document so the pages load faster -->
		<script src="js/bootstrap.min.js"></script>
		
	</form>
</body>
</html>
